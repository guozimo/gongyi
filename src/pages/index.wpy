<template>
<view>
<scroll-view class='page'>
  <!-- åˆ—è¡¨ -->
  <view class='CircleList' wx:for-items="{{feedObj.contents}}" wx:for-index="index" wx:for-item="item" wx:key="id" >
    <!-- å¤´åƒã€æ˜µç§°ã€å†…å®¹ -->
    <view class='body-view'>
      <!-- å¤´åƒ -->
      <view class='left-view'>
        <image class='user-icon' src='{{item.headImg}}'></image>
      </view>
      <view class='right-view' >
        <!-- æ˜µç§° -->
        <view class='user-name-view'>
          <label class='user-name'>{{item.name}}</label>
        </view>
        <!-- å†…å®¹ -->
        <view class='user-content-view'>
          <text class='user-content'>{{item.text}}</text>
        </view>
        <!-- å›¾ç‰‡ -->
        <view class='photo-view'>
          <view class='photo'  wx:for-items="{{item.imgUrls}}" wx:for-index="index" wx:for-item="one" wx:key="id" style='width:{{photoWidth}}px;height:{{photoWidth}}px'>
            <image bindtap='LookPhoto({{item.imgUrls}})' data-photUrl='{{one}}' src='{{one}}' style='width:{{photoWidth}}px;height:{{photoWidth}}px'></image>
          </view>
        </view>
        <!-- åœ°ç†ä½ç½® -->
        <!-- <view class='user-address-view'>
          <label>é•¿æ²™å¸‚å¤©å¿ƒåŒºèŠ™è“‰å—è·¯å››æ®µ158å·åœ°ç†ä¿¡æ¯äº§ä¸šå›­æ€»éƒ¨åŸºåœ°Aåº§9æ¥¼</label>
        </view> -->

        <!-- æ—¶é—´ã€åˆ é™¤æŒ‰é’®ã€ç‚¹èµè¯„è®ºæŒ‰é’® -->
        <view class='TDD-view'>
          <label>{{item.publishTime}}</label>
          <button bindtap='delete' wx:if='{{item.openid===openId}}'>åˆ é™¤</button>
          <image    src='/images/wxdiscuss.png' @tap ='TouchDiscuss({{index}})'></image>
          <image  src='/images/zan.png' wx:if='{{item.isShow&&!item.hasZan}}' class='zan_box' @tap='changeStatus({{index}})'/>
           <image  src='/images/cancel.png' wx:if='{{item.isShow&&item.hasZan}}' class='zan_box' @tap='changeStatus({{index}})'/>
        </view>

        <!-- ç‚¹èµ -->
        <view class='zan-view' wx:if='{{item.zan.length}}'>
          <view class='trigon-view'>
            <image mode='aspectFill' class='trigon' src='/images/trigon.png'></image>
          </view>

          <!-- ç‚¹èµ -->
          <view class='zan-bg-view'>
            <view class='heart'>ğŸ’˜</view>
            <view class='zan-user-view' wx:for-items="{{item.zan}}" wx:for-index="index" wx:for-item="one1" wx:key="id">
              <label bindtap='TouchZanUser' data-name='{{one1.name}}' class='zan-user'>{{one1.name?one1.name+',':''}}</label>
            </view>
          </view>
          <view class='line'></view>
          <!-- è¯„è®º -->
          <!-- <view class='discuss-view'>
            <view class='discuss' wx:for='{{contnet}}'>
              <label bindtap='TouchZanUser' data-name='{{item.firstname}}' class='discuss-user'>{{item.firstname}}ï¼š</label>
              <label class='content'>{{item.content}}</label>
            </view>
          </view> -->
        </view>
      </view>

    </view>
  </view>
</scroll-view>

<!-- è¯„è®ºæŒ‰é’®å¼¹å‡ºæ¡† -->
<view animation="{{animation}}" class='pop-up-box' style='top:{{popTop}}px;width: {{popWidth}}px;'>
</view>
 <view class='active'>
    <image src='/images/find.gif' class='active_img' @tap="gotoweb"/>
   </view>
   </view>
</template>

<script>
  import wepy from 'wepy'
  import {timestampToTime} from '@/utils/util'
  export default class Index extends wepy.page {
    onShareAppMessage() {
      return {
        title: 'ä¸ºå…¬å…¬ç›Šæ˜¯ä½ æˆ‘çš„å®¶å›­!',
        imageUrl: 'http://39.105.91.188/static/image/fm.jpg',
        path: `/pages/index`
      }
    }
    config = {
      navigationBarTitleText: 'åœˆå­'
    }
    components = {
    }

    data = {
      openId: wx.getStorageSync('openId') || '',
      // feedObj: {
      //   'contents': [{
      //     '_id': '5e6449f21c86150e47a2d31c',
      //     'publishTime': 1583630834865,
      //     'openId': '1',
      //     'name': 'weidong',
      //     'headImg': 'https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIPV2S8CfAd8AodjiacVHtibGOz9a5BQVsKIvNorQjonGiamPAU2Zzk5SH9kVJH1yv4rR4IM2M7AplfQ/132',
      //     '__v': 0,
      //     'zan': [{'openId': 'x9ks8a7wsic47jvq', 'name': 'ç™½å®‰'}],
      //     'imgUrls': ['http://39.105.91.188/static/image/fm.jpg']
      //   }, {
      //     '_id': '5e637c56da556a841bd0d643',
      //     'publishTime': 1583578198091,
      //     'text': 'è°ƒç”¨æ¥å£',
      //     'openId': 'b9iqatg0uq9nj78d',
      //     'name': 'å¿†ä¸¹',
      //     'headImg': 'https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIPV2S8CfAd8AodjiacVHtibGOz9a5BQVsKIvNorQjonGiamPAU2Zzk5SH9kVJH1yv4rR4IM2M7AplfQ/132',
      //     '__v': 0,
      //     'zan': [],
      //     'imgUrls': ['http://39.105.91.188/static/image/fm.jpg']
      //   }]
      // },
      feedObj:{contents:[]},
      code:'',
      photoWidth: wx.getSystemInfoSync().windowWidth / 5,
      popTop: 0, // å¼¹å‡ºç‚¹èµè¯„è®ºæ¡†çš„ä½ç½®
      popWidth: 0, // å¼¹å‡ºæ¡†å®½åº¦
      userName: wx.getStorageSync('userInfo').nickName || '',
      baseUrl: 'http://39.105.91.188:8000/api'

    }

    computed = {
    }

    methods = {
      gotoweb() {
        wepy.navigateTo({
          url: '/pages/active/active'
        })
      },
      changeStatus(index) {
      // åˆ‡æ¢çŠ¶æ€
       this.feedObj.contents[index].isShow= false
       // è¯·æ±‚ç‚¹èµæˆ–è€…å–æ¶ˆç‚¹èµçš„æ¥å£
       // å¦‚æœå½“å‰æ˜¯å·²ç»ç‚¹èµçŠ¶æ€ é‚£ä¹ˆç”¨æˆ·æ˜¯ç™»å½•çŠ¶æ€ ç‚¹å‡»è¿›è¡Œå–æ¶ˆç‚¹èµ å‘é€å–æ¶ˆç‚¹èµçš„è¯·æ±‚
       // å¦‚æœå½“å‰æ˜¯æœªç‚¹èµçŠ¶æ€ é‚£ä¹ˆç”¨æˆ·æ˜¯æœªç™»å½•æˆ–è€…å·²ç»ç™»å½•è¿˜æœªç‚¹èµ
       if(this.feedObj.contents[index].hasZan){
         // å·²ç»å¯¹æŸæ¡æ•°æ®è¿›è¡Œäº†ç‚¹èµ //å‘é€å–æ¶ˆç‚¹èµçš„è¯·æ±‚
          wx.request({
              url: this.baseUrl + '/zan',
              method: 'POST',
              data: {
                _id:this.feedObj.contents[index]._id || '',
                opera: "delete",
                openid:wx.getStorageSync('openId') || '',
                code: '',
                name:wx.getStorageSync('userInfo').nickName || 'ğŸ’—'
              },
              header: {
                'Content-Type': 'application/json'
              },
              success: res => {
                  console.log('å–æ¶ˆç‚¹èµè¿”å›çš„æ•°æ®res', res)
                  if(res.data.status){
                 wepy.showToast({
                  title: 'å–æ¶ˆç‚¹èµæˆåŠŸ',
                  icon: 'none',
                  duration: 3000
                })
                // zan åˆ—è¡¨ä¸­æŠŠè‡ªå·±çš„åå­—æœ¬åœ°é™¤å»
                let len = this.feedObj.contents[index].zan.length-1
                this.feedObj.contents[index].zan.splice(len,1)
                this.feedObj.contents[index].hasZan = !this.feedObj.contents[index].hasZan
                  } else {
                  wepy.showToast({
                  title: 'å–æ¶ˆç‚¹èµå¤±è´¥',
                  icon: 'none',
                  duration: 3000
                })
                }
                this.$apply()
              },
              fail: error => {
                console.log('å–æ¶ˆç‚¹èµå¤±è´¥', error)
                // mockçš„æ•°æ®
                // let len = this.feedObj.contents[index].zan.length-1
                // this.feedObj.contents[index].zan.splice(len,1)
                // this.$apply()
                wepy.showToast({
                  title: 'å–æ¶ˆç‚¹èµå¤±è´¥',
                  icon: 'none',
                  duration: 3000
                })
              }
            })
       } else {
         // æœªç™»å½•æˆ–è€…ç™»å½•æœªç‚¹èµ
         if(wx.getStorageSync('openId')){
           // å¦‚æœæ˜¯å·²ç»ç™»å½•æœªç‚¹èµ å‘é€ç‚¹èµè¯·æ±‚ å‘openId
             wx.request({
              url: this.baseUrl + '/zan',
              method: 'POST',
              data: {
                _id:this.feedObj.contents[index]._id || '',
                opera: "insert",
                openid:wx.getStorageSync('openId') || '',
                code: '',
                name:wx.getStorageSync('userInfo').nickName || 'ğŸ’—'
              },
              header: {
                'Content-Type': 'application/json'
              },
              success: res => {
                  console.log('å·²ç™»å½•ç‚¹èµè¿”å›çš„æ•°æ®res', res)
                  if(res.data.status){
                  wepy.showToast({
                  title: 'ç‚¹èµæˆåŠŸ',
                  icon: 'none',
                  duration: 3000
                })
                // zan åˆ—è¡¨ä¸­æŠŠè‡ªå·±çš„åå­—æœ¬åœ°åŠ å…¥
                this.feedObj.contents[index].zan.push({'openid': this.openId, 'name': wx.getStorageSync('userInfo').nickName || 'ğŸ’—'})
                this.feedObj.contents[index].hasZan = !this.feedObj.contents[index].hasZan
                } else {
                  wepy.showToast({
                  title: 'ç‚¹èµå¤±è´¥',
                  icon: 'none',
                  duration: 3000
                  })
                }
                this.$apply()
              },
              fail: error => {
                console.log('å·²ç™»å½•ç‚¹èµå¤±è´¥', error)
                wepy.showToast({
                  title: 'ç‚¹èµå¤±è´¥',
                  icon: 'none',
                  duration: 3000
                })
              }
            })
         } else {
           // æœªç™»å½• å‘é€ç‚¹èµè¯·æ±‚
           // é¦–å…ˆéœ€è¦ç™»å½•
            wepy.login({
             success: res => {
            this.code = res.code
             wx.request({
              url: this.baseUrl + '/zan',
              method: 'POST',
              data: {
                 _id:this.feedObj.contents[index]._id || '',
                opera: "insert",
                openid:'',
                code: this.code || '',
                name:wx.getStorageSync('userInfo').nickName || 'ğŸ’—'
              },
              header: {
                'Content-Type': 'application/json'
              },
              success: res => {
                  console.log('æœªç™»å½•æ— æ„Ÿç™»å½•ç‚¹èµè¿”å›çš„æ•°æ®res', res)
                   if(res.data.status){
                 wepy.showToast({
                  title: 'ç‚¹èµæˆåŠŸ',
                  icon: 'none',
                  duration: 3000
                })
                // æŠŠopenid å­˜å…¥storageä¸­
                if(res.data.openid){
                 wx.setStorageSync('openId',res.data.openid)
                }
                // zan åˆ—è¡¨ä¸­æŠŠè‡ªå·±çš„åå­—æœ¬åœ°åŠ å…¥
                this.feedObj.contents[index].zan.push({'openid': res.data.openid|| '', 'name': 'ğŸ’—'})
                this.feedObj.contents[index].hasZan = !this.feedObj.contents[index].hasZan
                   } else {
                   showToast({
                    title: 'ç‚¹èµå¤±è´¥',
                  icon: 'none',
                  duration: 3000
                  })
                   }
                 
                this.$apply()
                //æœªç™»å½•ç›´æ¥åˆ·æ–°åˆ—è¡¨
              },
              fail: error => {
                console.log('æ— æ„ŸçŸ¥ç™»å½•ç‚¹èµå¤±è´¥', error)
                wepy.showToast({
                  title: 'ç‚¹èµå¤±è´¥',
                  icon: 'none',
                  duration: 3000
                })
                // mockçš„æ•°æ®
                // this.feedObj.contents[index].zan.push({'openId': '', 'name': 'ğŸ’—'})
                // this.feedObj.contents[index].hasZan = !this.feedObj.contents[index].hasZan
                this.$apply()
              }
            })
            }
            })
         }
       }
     // this.feedObj.contents[index].hasZan= !this.feedObj.contents[index].hasZan
      },
       // ç‚¹å‡»å›¾ç‰‡è¿›è¡Œå¤§å›¾æŸ¥çœ‹
      LookPhoto: function(item,e) {
        wx.previewImage({
          current: e.currentTarget.dataset.photurl,
          urls: item || []
        })
      },

  // ç‚¹å‡»ç‚¹èµçš„äºº
      TouchZanUser: function(e) {
        wx.showModal({
          title: e.currentTarget.dataset.name,
          showCancel: false
        })
      },

  // åˆ é™¤æœ‹å‹åœˆ
      delete: function() {
        this.deletePiece()
      },
      deletePiece(){
        // åˆ é™¤å•æ¡åŠ¨æ€
         wx.request({
         url: this.baseUrl + '/delete',
         header: {
        'content-type': 'application/json' // é»˜è®¤å€¼
         },
        method: 'POST',
        success: res => {
        console.log('åˆ é™¤åŠ¨æ€è¿”å›çš„æ•°æ®', res)
         wx.showToast({
          title: 'åˆ é™¤æˆåŠŸ'
        })
         },
        fail: function (error) {
        wepy.hideLoading()
        console.error('åˆ é™¤å•æ¡æ•°æ®å¤±è´¥', error)
        wepy.showToast({title: 'åˆ é™¤æ•°æ®å¤±è´¥'})
         }
       })
      },

  // ç‚¹å‡»äº†ç‚¹èµè¯„è®º
      TouchDiscuss: function(index) {
       this.feedObj.contents[index].isShow= !this.feedObj.contents[index].isShow
      }
    }

    events = {
    }
  getFeed(){ 
    wx.request({
      url: this.baseUrl + '/get',
      header: {
        'content-type': 'application/json' // é»˜è®¤å€¼
      },
      method: 'GET',
      success: res => {
        console.log('è·å–çš„ç”¨æˆ·feedåˆ—è¡¨æˆåŠŸ', res)
        if(res.data){
         this.feedObj = res.data
         this.feedObj.contents = this.feedObj.contents.length && this.feedObj.contents.map((item) => {
        if (item.publishTime) {
          item.publishTime = timestampToTime(item.publishTime)
        }
        item.isShow = false// è¿™ä¸ªå‚æ•°æ˜¯é»˜è®¤ä¸å‡ºå±•ç¤ºboxçš„
        // è¿˜éœ€è¦åˆ¤æ–­å¦‚æœå±•ç¤ºäº†box å±•ç¤ºçš„ç±»å‹æ˜¯ç‚¹èµè¿˜æ˜¯å–æ¶ˆ
        let hasZan = false
         hasZan = item.zan.length&&item.zan.some((one)=>{
               return one.openid === this.openId
         });
         if(hasZan) { 
           // å¦‚æœåˆ—è¡¨ä¸­å·²ç»å­˜åœ¨ä½ è‡ªå·±çš„èµäº† é‚£ä¹ˆå°±æ˜¾ç¤ºå–æ¶ˆ
           item.hasZan = true
         } else {
           // æ²¡æœ‰åŒ¹é…åˆ° è¦ä¹ˆæ˜¯æ²¡æœ‰ç™»å½• è¦ä¹ˆæ˜¯ç™»å½•äº† ä½†æ˜¯ç¡®å®æ²¡æœ‰ä½ çš„èµ ä½ éœ€è¦è¿›è¡Œç‚¹èµæ“ä½œ
           // ç™»å½•å¦‚ä½•åš æ²¡æœ‰ç™»å½•å¦‚ä½•åš
           item.hasZan = false
         }



        return item
      })
          this.$apply()
        }
        wepy.hideLoading()
        
      },
      fail: function (error) {
        wepy.hideLoading()
        console.error('è·å–ç”¨æˆ·feedåˆ—è¡¨å¤±è´¥', error)
        wepy.showToast({title: 'feedåˆ—è¡¨å¤±è´¥'})
      }
    })
  }
    onLoad() {
    }
    onShow(){
  // è·å–åˆ—è¡¨çš„æ¥å£ å‘æ–‡ç« è·³è¿‡æ¥çš„æ“ä½œ
      // console.log(this.openId,"openId")
      this.getFeed()
    }
  }
</script>

<style lang="less">
/* pages/CircleFriends/CircleFriends.wxss */
page{
  background: whitesmoke;
}
  .active {
  width:116rpx;
  height:116rpx;
  position:fixed;
  bottom:50rpx;
  right:20rpx;
  .active_img{
    width:100%;
    height:100%;
  }
  }
.page{
  width: 100%;
  /* overflow-x: hidden */
}

/* åˆ—è¡¨ */
.CircleList{
  background: white;
  margin-bottom: 1px;
  border-bottom: 1px solid whitesmoke;
  border-top: 1px solid whitesmoke;
}

.body-view{
  display: flex;
}

.left-view{
  width: 150rpx;
  /* background: rebeccapurple; */
}

.right-view{
  /* background: red; */
}

/* å¤´åƒ */
.user-icon{
  /* display: flex; */
  width:100rpx;
  height: 100rpx;
  margin-left: 20rpx;
  margin-top: 30rpx;
  margin-right: 20rpx;
  border-radius: 50%
}

/* æ˜µç§° */
.user-name{
  display: flex;
  height: 50rpx;
  line-height: 50rpx;
  font-size: 18px;
  color: rgb(88, 103, 138);
  margin-top: 30rpx;
  margin-left: 10rpx;
}

/* å†…å®¹ */
.user-content{
  display: flex;
  font-size: 18px;
  line-height: 50rpx;
  margin-left: 10rpx;
}

/* å›¾ç‰‡ */
.photo-view{
  background: rebeccapurple;
  margin-left: 10rpx;
  margin-bottom: 20rpx;
}
.photo{
  background: rgb(255, 166, 0);  
  float: left;
  margin-right: 10rpx;
  margin-top: 10rpx;
}

/* åœ°ç†ä½ç½® */
.user-address-view{
  display: flex;
  margin-top: 20rpx;
  width: 100%;
}
.user-address-view label{
  font-size: 12px;
  margin: 10rpx;
}

/* æ—¶é—´ã€åˆ é™¤ã€ç‚¹èµè¯„è®º */
.TDD-view{
  width: 100%;
  height: 60rpx;
  display: flex;
  align-items: center;
  background: white;
  position:relative;
   .zan_box{
    width:160rpx;
    height:68rpx;
    display:block;
    position:absolute;
    top:0;
    right:55rpx;
  }
}
.TDD-view label{
  font-size: 13px;
  margin-left: 10rpx;
}
.TDD-view button{
  font-size: 13px;
  margin-left: 20rpx;
  color: black;
  background: white;
}
.TDD-view button::after{
  border: white;
}
.TDD-view image{
  width: 50rpx;
  height: 40rpx;
  margin-right: 20rpx;
}

/* ç‚¹èµ */
.zan-view {
  width: 100%;
  background: white;
  margin-bottom: 20rpx;
}
.trigon-view{
  /* height: 20rpx; */
  margin-bottom: -15rpx;
}
.trigon{
  display: flex;
  width: 40rpx;
  height: 20rpx;
  margin-top: 10rpx;
  margin-left: 10rpx;
}
.zan-bg-view{
  display:inline-block;
  width: 97%;
  background: rgb(235, 235, 235);
  margin-right: 20rpx;
  margin-bottom: -11rpx;
  border-top-left-radius: 7rpx;
  border-top-right-radius: 7rpx;
  position:relative;
  .heart{
   display: flex;
  float: left;
  margin-left: 10rpx;
  margin-top:-5rpx;
   }
}
.zan-user-view{
  display: flex;
  float: left;
  height: 40rpx;
  margin-left: 10rpx;
  /* margin-top: 5rpx; */
  align-content: center;
}
.zan-user{
  font-size: 12px;
  line-height: 40rpx;
  height: 40rpx;
  color: rgb(88, 103, 138);
}

.line{
  width: 97%;
  height: 1px;
  background: white;
}

/* è¯„è®º */
.discuss-view{
  background: white;
  width: 97%;
}

.discuss{
  background: rgb(235, 235, 235);
  line-height: 35rpx;
}

.discuss label{
  font-size: 12px;
}

.discuss-user{
  color: rgb(88, 103, 138);
  margin-left: 10rpx;
}

.content{
  margin-left: 10rpx;
}

/* å¼¹å‡ºæ¡† */
.pop-up-box{
  position: absolute;
  height: 60rpx;
  border-radius: 10rpx;
  right: 90rpx;
  background: rgba(0, 0, 0, 0.7);
 
}
</style>
